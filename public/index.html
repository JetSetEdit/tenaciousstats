<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenacious Stats Dashboard</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        .header {
            background: rgb(0, 0, 0);
            color: white;
            padding: 2rem;
            border-left: 4px solid #ff5800;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-logo {
            height: 60px;
            width: auto;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .sidebar {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input[type="date"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .checkbox-group {
            margin-top: 1rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-weight: 400;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        button {
            background-color: #ff5800;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
        }

        button:hover {
            background-color: #d43d00;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            color: #ff5800;
            font-size: 2rem;
            font-weight: 700;
        }

        .section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Tabbed Interface Styles */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .tabs-header {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
        }

        .tab-button {
            background: transparent;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            margin: 0;
            border-radius: 0;
            width: auto;
        }

        .tab-button:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .tab-button.active {
            color: #ff5800;
            border-bottom-color: #ff5800;
            background: white;
            font-weight: 700;
        }

        .tab-content {
            display: none;
            padding: 2rem;
        }

        .tab-content.active {
            display: block;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Tooltip Styles */
        .tooltip-trigger {
            position: relative;
            cursor: help;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tooltip-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #7f8c8d;
            color: white;
            font-size: 11px;
            line-height: 16px;
            text-align: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .tooltip-trigger:hover .tooltip-icon {
            background: #ff5800;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 0.75rem 1rem;
            background: #2c3e50;
            color: white;
            font-size: 0.875rem;
            line-height: 1.4;
            border-radius: 4px;
            white-space: normal;
            width: 280px;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #2c3e50;
        }

        .tooltip-trigger:hover .tooltip {
            opacity: 1;
            pointer-events: auto;
        }

        .metric-label {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Navigation Menu Styles */
        .nav-menu {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 0;
            margin-bottom: 2rem;
            margin-top: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border-radius: 0;
        }

        .nav-menu .container {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .nav-item {
            padding: 1rem 1.5rem;
            color: #2c3e50;
            text-decoration: none;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
            display: inline-block;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            border-radius: 0;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            flex: 1;
            text-align: center;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #ff5800;
        }

        .nav-item.active {
            color: #ff5800;
            border-bottom-color: #ff5800;
            font-weight: 700;
        }

        .nav-content-section {
            display: none;
        }

        .nav-content-section.active {
            display: block;
        }

        /* A4 Report Container Styling */
        #reportContainer {
            width: 794px !important;
            /* A4 width: 210mm at 96 DPI */
            max-width: 794px !important;
            min-height: 1123px;
            /* A4 height: 297mm at 96 DPI */
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-sizing: border-box;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        /* Report section styling - ensure images don't get cut off */
        .report-section {
            overflow: visible !important;
        }

        .report-section img {
            max-width: 100% !important;
            width: 100% !important;
            height: auto !important;
            box-sizing: border-box !important;
            object-fit: contain !important;
            display: block !important;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 700;
            color: #2c3e50;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
            margin-top: 3rem;
        }

        .footer-version {
            font-size: 0.75rem;
            color: #b0b0b0;
            margin-top: 1rem;
            opacity: 0.7;
        }

        @media print {

            /* Page setup - A4 portrait (210mm x 297mm) */
            @page {
                size: A4 portrait;
                margin: 1cm 1cm 2.5cm 1cm;
                /* Extra bottom margin for footer */
                /* Note: Browser print headers/footers (URL, page numbers) 
                   cannot be removed via CSS. Disable them in your browser's 
                   print dialog: "More settings" > Uncheck "Headers and footers" */
            }

            /* Print footer that appears on every page */
            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 1.5cm;
                border-top: 2px solid #ff5800;
                background: white;
                z-index: 1000;
                page-break-inside: avoid;
            }

            .print-footer-content {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.3cm 1cm;
                font-size: 9pt;
                color: #7f8c8d;
            }

            .print-footer-text {
                flex: 1;
            }

            .print-page-number {
                flex: 1;
                text-align: right;
            }

            /* Page numbering */
            .page-number {
                /* Current page will be updated by browser's native page counter if supported */
                display: inline;
            }

            /* Preserve colors where needed */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Hide all interactive and non-essential elements */
            .sidebar,
            .header,
            .footer,
            .loading,
            .checkbox-group,
            .form-group,
            input,
            label:not(.report-section-title),
            .chart-container,
            .plotly,
            [id^="chart"],
            .footer-version,
            .nav-menu,
            .nav-item,
            .tabs-container,
            .tabs-header,
            .tab-button {
                display: none !important;
            }

            /* Hide all buttons when printing (including print button) */
            button {
                display: none !important;
            }

            /* Hide configuration heading when printing */
            .config-heading {
                display: none !important;
            }

            /* Show glossary section when printing */
            #glossary-section {
                display: block !important;
            }

            /* Show print header when printing */
            .glossary-print-header {
                display: block !important;
                page-break-after: avoid;
                margin-bottom: 1rem;
            }

            /* Glossary print styles */
            #glossary-section .section {
                page-break-inside: auto;
            }

            #glossary-section h2 {
                page-break-after: avoid;
                margin-bottom: 1rem !important;
                margin-top: 0 !important;
            }

            #glossary-section h3 {
                page-break-after: avoid;
                page-break-before: auto;
                margin-top: 1.5rem !important;
                margin-bottom: 0.75rem !important;
            }

            /* Table page break handling */
            #glossary-section table.report-table {
                page-break-inside: auto;
                margin-bottom: 1.5rem;
            }

            #glossary-section table.report-table thead {
                display: table-header-group;
            }

            #glossary-section table.report-table tbody tr {
                page-break-inside: avoid;
            }

            /* Clean table styling for glossary */
            #glossary-section table {
                width: 100%;
                border-collapse: collapse;
                margin: 1rem 0;
            }

            #glossary-section table th,
            #glossary-section table td {
                padding: 0.75rem;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }

            #glossary-section table th {
                background-color: #f8f9fa;
                font-weight: 700;
                color: #2c3e50;
                border-bottom: 2px solid #ff5800;
            }

            #glossary-section table tr:last-child td {
                border-bottom: none;
            }

            /* Ensure glossary content is visible */
            .nav-content-section {
                display: block !important;
            }

            /* Reset body for print */
            body {
                background: white !important;
                color: black !important;
                font-size: 11pt !important;
                line-height: 1.5 !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            /* Main container - use physical units */
            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Report section container */
            .section {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0.5cm !important;
                box-shadow: none !important;
                border: none !important;
                background: white !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
            }

            #reportContainer {
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
            }

            /* Ensure all report content fits within margins */
            .report-section>* {
                max-width: 100% !important;
                box-sizing: border-box !important;
            }

            /* Report sections - prevent breaking and start each on new page */
            .report-section {
                page-break-inside: avoid !important;
                page-break-before: always !important;
                margin-bottom: 1.2cm !important;
                padding: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                box-sizing: border-box !important;
                overflow: visible !important;
            }

            /* First section should not have page break before */
            .report-section:first-of-type,
            .report-section[data-is-first-section="true"] {
                page-break-before: auto !important;
            }

            /* Ensure charts stay with their section */
            .report-section img,
            .report-section [id^="report"] {
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }

            /* Headings */
            h1 {
                font-size: 20pt !important;
                color: black !important;
                margin: 0.5cm 0 0.3cm 0 !important;
                page-break-after: avoid !important;
                font-weight: bold !important;
            }

            h2,
            .report-section-title {
                font-size: 14pt !important;
                color: black !important;
                margin: 0.8cm 0 0.4cm 0 !important;
                padding-bottom: 0.2cm !important;
                border-bottom: 1.5pt solid #ff5800 !important;
                page-break-after: avoid !important;
                page-break-inside: avoid !important;
                font-weight: bold !important;
            }

            h3 {
                font-size: 12pt !important;
                color: black !important;
                margin: 0.5cm 0 0.3cm 0 !important;
                page-break-after: avoid !important;
                font-weight: bold !important;
            }

            /* Paragraphs and text */
            p {
                color: black !important;
                font-size: 11pt !important;
                margin: 0.3cm 0 !important;
                line-height: 1.5 !important;
            }

            /* Tables - print optimized */
            table,
            .report-table {
                width: 100% !important;
                max-width: 100% !important;
                border-collapse: collapse !important;
                margin: 0.5cm 0 !important;
                page-break-inside: auto !important;
                font-size: 10pt !important;
                table-layout: fixed !important;
                box-sizing: border-box !important;
                border: 1pt solid #666 !important;
            }

            thead {
                display: table-header-group !important;
            }

            tbody {
                display: table-row-group !important;
            }

            tfoot {
                display: table-footer-group !important;
            }

            tr {
                page-break-inside: avoid !important;
                page-break-after: auto !important;
            }

            th {
                background: #f0f0f0 !important;
                color: black !important;
                font-weight: bold !important;
                border: 1pt solid #666 !important;
                padding: 0.3cm !important;
                text-align: left !important;
                font-size: 10pt !important;
                box-sizing: border-box !important;
                word-wrap: break-word !important;
            }

            td {
                border: 1pt solid #ccc !important;
                padding: 0.25cm !important;
                color: black !important;
                font-size: 10pt !important;
                box-sizing: border-box !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                max-width: 0 !important;
            }

            /* Images */
            img {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                display: block !important;
                margin: 0.5cm auto !important;
                box-sizing: border-box !important;
                object-fit: contain !important;
            }

            /* Logo - maintain fixed size in print */
            img[alt*="Logo"],
            img[alt*="logo"],
            .report-logo {
                width: auto !important;
                max-width: 200px !important;
                height: 60px !important;
                max-height: 60px !important;
            }

            /* Report section images - ensure they fit */
            .report-section img {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                box-sizing: border-box !important;
                object-fit: contain !important;
            }

            /* Lists */
            ul,
            ol {
                margin: 0.3cm 0 0.3cm 1.5cm !important;
                padding: 0 !important;
                color: black !important;
            }

            li {
                color: black !important;
                font-size: 11pt !important;
                margin: 0.2cm 0 !important;
                line-height: 1.5 !important;
            }

            /* Grid layouts - convert to block for print */
            div[style*="display: grid"],
            div[style*="grid-template-columns"],
            .metrics-grid {
                display: block !important;
            }

            div[style*="display: grid"]>*,
            div[style*="grid-template-columns"]>* {
                display: block !important;
                margin-bottom: 0.3cm !important;
                width: 100% !important;
            }

            /* Executive summary grid */
            div[style*="grid-template-columns: repeat(2, 1fr)"] {
                display: block !important;
            }

            div[style*="grid-template-columns: repeat(2, 1fr)"]>div {
                display: block !important;
                margin-bottom: 0.3cm !important;
                padding: 0.2cm 0 !important;
                border-bottom: 0.5pt solid #eee !important;
            }

            /* Background colors - preserve light backgrounds, remove dark */
            div[style*="background: #f8f9fa"],
            div[style*="background-color: #f8f9fa"],
            .report-insights {
                background: #f8f9fa !important;
                border: 1pt solid #ddd !important;
                padding: 0.5cm !important;
                margin: 0.5cm 0 !important;
            }

            /* Remove other background colors */
            div[style*="background:"]:not([style*="background: #f8f9fa"]):not([style*="background-color: #f8f9fa"]),
            div[style*="background-color:"]:not([style*="background: #f8f9fa"]):not([style*="background-color: #f8f9fa"]) {
                background: white !important;
            }

            /* Text colors - ensure black for print */
            p,
            div,
            span,
            li,
            td,
            th {
                color: black !important;
            }

            /* Orange accents - keep for headers but ensure readability */
            h2[style*="color: #ff5800"],
            h2[style*="color: #FE5000"] {
                color: black !important;
                border-bottom-color: #ff5800 !important;
            }

            /* Report header */
            div[style*="text-align: center"] {
                text-align: center !important;
                margin-bottom: 1cm !important;
                padding-bottom: 0.5cm !important;
                border-bottom: 2pt solid #ff5800 !important;
            }

            /* Monospace text */
            td[style*="font-family: monospace"],
            span[style*="font-family: monospace"] {
                font-family: 'Courier New', monospace !important;
                font-size: 9pt !important;
            }

            /* Strong/bold text */
            strong,
            b {
                font-weight: bold !important;
                color: black !important;
            }

            /* Remove borders and shadows */
            * {
                box-shadow: none !important;
            }

            div[style*="border-radius"] {
                border-radius: 0 !important;
            }

            /* Ensure no overflow */
            * {
                overflow: visible !important;
            }

            /* Page breaks */
            .report-section:first-of-type {
                page-break-before: auto !important;
            }

            /* Avoid breaking tables across pages when possible */
            table.report-table {
                page-break-inside: avoid !important;
            }

            /* If table is too large, allow breaking but keep header */
            table.report-table thead tr {
                page-break-after: avoid !important;
            }
        }

        /* Password Protection Modal Styles */
        #password-protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: 'Roboto', sans-serif;
        }

        #password-protection-overlay.hidden {
            display: none;
        }

        .password-modal {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }

        .password-modal img {
            height: 60px;
            margin-bottom: 1.5rem;
        }

        .password-modal h2 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
        }

        .password-modal p {
            color: #7f8c8d;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .password-input-group {
            margin-bottom: 1.5rem;
        }

        .password-input-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .password-input-group input:focus {
            outline: none;
            border-color: #ff5800;
        }

        .password-submit-btn {
            width: 100%;
            padding: 1rem;
            background-color: #ff5800;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .password-submit-btn:hover {
            background-color: #d43d00;
        }

        .password-error {
            color: #e74c3c;
            margin-top: 1rem;
            font-size: 0.9rem;
            display: none;
        }

        .password-error.show {
            display: block;
        }

        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Password Protection Overlay -->
    <div id="password-protection-overlay">
        <div class="password-modal">
            <img src="https://www.tenacioustapes.com.au/wp-content/uploads/2025/12/tenacious-tapes-logo-scaled.png"
                alt="Tenacious Tapes Logo" style="height: 60px; max-height: 60px; width: auto; max-width: 200px;">
            <h2>üîí Protected Dashboard</h2>
            <p>Please enter the password to access the analytics dashboard</p>
            <form id="password-form" onsubmit="checkPassword(event)">
                <div class="password-input-group">
                    <input type="password" id="password-input" placeholder="Enter password" autofocus required>
                </div>
                <button type="submit" class="password-submit-btn">Access Dashboard</button>
                <div class="password-error" id="password-error">Incorrect password. Please try again.</div>
            </form>
        </div>
    </div>

    <!-- Main Content (hidden until authenticated) -->
    <div class="main-content" id="main-content">
        <div class="header">
            <div class="container" style="display: flex; align-items: center; gap: 1.5rem;">
                <img src="https://www.tenacioustapes.com.au/wp-content/uploads/2025/08/logo-1-scaled.png"
                    alt="Tenacious Tapes Logo" class="header-logo">
                <div class="header-content">
                    <h1>üìä Tenacious Stats Dashboard</h1>
                    <p>Analytics for Tenacious Tapes - Adhesive Tapes for every application</p>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <nav class="nav-menu">
            <div class="container">
                <button class="nav-item active"
                    onclick="showNavSection('dashboard', event); return false;">Dashboard</button>
                <button class="nav-item" onclick="showNavSection('glossary', event); return false;">Glossary</button>
            </div>
        </nav>

        <div class="container">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="nav-content-section active">
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 2rem;">
                    <!-- Sidebar -->
                    <div class="sidebar">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="endDate">
                        </div>
                        <div class="checkbox-group">
                            <label><input type="checkbox" value="Overview" checked> Overview</label>
                            <label><input type="checkbox" value="Traffic Sources" checked> Traffic Sources</label>
                            <label><input type="checkbox" value="Top Pages" checked> Top Pages</label>
                            <label><input type="checkbox" value="User Retention"> User Retention</label>
                            <label><input type="checkbox" value="Geographics"> Geographics</label>
                            <label><input type="checkbox" value="Tech/Devices"> Tech/Devices</label>
                            <label><input type="checkbox" value="Events"> Events</label>
                            <label><input type="checkbox" value="Business Profile"> Business Profile</label>
                        </div>
                        <button onclick="loadData()">Refresh Data</button>
                        <button onclick="generateReport()" style="margin-top: 0.5rem; background-color: #4a90e2;">üìÑ
                            Generate Monthly Report</button>
                        <h3 class="config-heading">‚öôÔ∏è Configuration</h3>
                    </div>

                    <!-- Main Content -->
                    <div id="content">
                        <div class="loading">Configure dates and click "Refresh Data" to load analytics</div>
                    </div>
                </div>
            </div>

            <!-- Glossary Section -->
            <div id="glossary-section" class="nav-content-section">
                <!-- Print Header (only visible when printing) -->
                <div class="glossary-print-header" style="display: none;">
                    <div
                        style="text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #ff5800;">
                        <img src="https://www.tenacioustapes.com.au/wp-content/uploads/2025/12/tenacious-tapes-logo-scaled.png"
                            alt="Tenacious Tapes Logo"
                            style="height: 60px; max-height: 60px; width: auto; max-width: 200px; margin-bottom: 1rem;">
                        <h1 style="color: #2c3e50; margin-bottom: 0.5rem; font-size: 2rem;">Analytics Glossary</h1>
                        <p style="color: #7f8c8d; font-size: 1.1rem;">Tenacious Tapes - Adhesive Tapes for every
                            application</p>
                    </div>
                </div>

                <!-- Print Button (outside section) -->
                <div style="margin-bottom: 1.5rem; text-align: right;">
                    <button onclick="window.print()"
                        style="background-color: #ff5800; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        üñ®Ô∏è Print Glossary
                    </button>
                </div>

                <div class="section">
                    <h2 style="margin-top: 0;">Glossary</h2>
                    <p style="margin-bottom: 2rem; color: #7f8c8d;">Comprehensive definitions of analytics terms and
                        metrics used in this dashboard. Hover over terms in the interactive dashboard to see quick
                        tooltips.</p>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Executive Summary Metrics</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Total Sessions</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Total number of visits to the site in this period. One person can create multiple
                                    sessions if they return.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Total Users</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Estimated number of unique people who visited the site in this period.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Page Views</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Total times any page on the site was loaded or viewed, including repeats.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Engagement Rate</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Percent of sessions where visitors did something meaningful, like viewing multiple
                                    pages, staying a while, or triggering key events.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Avg. Session Duration</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Average time visitors actively spent on the site during a visit.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Bounce Rate</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Percent of sessions where visitors left after only one page with no meaningful
                                    interaction.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Traffic Sources</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Source</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Where the visit came from, such as Google, email, social, or people typing the URL
                                    directly.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    (direct) / (none)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Visits with no clear referrer ‚Äì usually people typing the URL, using bookmarks, or
                                    coming from untagged links.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    / organic</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Free clicks from search engine results (not paid ads).</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    / referral</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Clicks from links on other websites that send traffic to this site.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    / email</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Visits from tracked links in marketing emails.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Percentage (in sources)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Share of all sessions that came from this source in the selected period.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Sessions (in sources)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Number of visits that came from this source.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Top Pages & Searched Products</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Views (pages/products)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    How many times this page or product was viewed in the selected period.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Users (pages/products)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    How many unique visitors viewed this page or product at least once.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        User Retention</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    New Users</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    People visiting the site for the first time on this device/browser.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Returning Users</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    People who have visited before on this device/browser and came back in this period.
                                </td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Percentage (retention)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Share of total sessions that came from new vs returning visitors.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Geography & Devices</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Sessions by Country / Top Cities</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Where visits originated, based on IP location; some traffic may be "not set" if
                                    location is unclear.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Device Category (desktop / mobile / tablet)</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Type of device used for the visit, helping you see whether people browse more on
                                    computers or phones.</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Events</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Event Name</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    A specific action that was tracked on the site, such as viewing a page, scrolling,
                                    or submitting a form.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    page_view</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded whenever a page loads or is viewed.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    user_engagement</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a visitor stays on a page for long enough or interacts so the session
                                    counts as engaged.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    session_start</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a new visit begins.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    first_visit</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded the first time a device/browser ever visits the site.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    scroll</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a visitor scrolls down far enough on a page, showing they looked
                                    beyond the top.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    form_start / form_submit</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    form_start: when someone begins filling out a form. form_submit: when they
                                    successfully send it.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    click</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a tracked link or button is clicked.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    file_download</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a visitor downloads a tracked file, such as a PDF or brochure.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    click_buy_online</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Recorded when a visitor clicks a "buy online" or similar outbound purchase link.
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <h3
                        style="color: #ff5800; margin-top: 2rem; margin-bottom: 1rem; border-bottom: 2px solid #ff5800; padding-bottom: 0.5rem;">
                        Google Business Profile</h3>
                    <table class="report-table"
                        style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 2rem;">
                        <colgroup>
                            <col style="width: 30%;">
                            <col style="width: 70%;">
                        </colgroup>
                        <thead>
                            <tr style="background-color: #f8f9fa;">
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Term</th>
                                <th
                                    style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">
                                    Definition</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Search Views</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Number of times your business appeared in Google Search results.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Maps Views</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Number of times your business appeared on Google Maps.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Website Clicks</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Number of clicks to your website from your Google Business Profile listing.</td>
                            </tr>
                            <tr>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; font-weight: 700; color: #2c3e50;">
                                    Direction Requests</td>
                                <td
                                    style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; color: #555;">
                                    Number of requests for driving directions to your business location.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <p><strong>Tenacious Tapes</strong> - Adhesive Tapes for every application</p>
            <p>üìû +61 (0)3 9580 5573 | ‚úâÔ∏è customerservice@tenacioustapes.com.au</p>
            <p class="footer-version" id="versionDisplay">Build v1.0.0</p>
        </div>
    </div> <!-- End main-content -->

    <script>
        // Password Protection - FREE Solution
        // Password: Tenacious2025 (change this to your preferred password)
        const DASHBOARD_PASSWORD = 'Tenacious2025';
        const AUTH_KEY = 'dashboard_authenticated';

        // Check if we're in local development (skip password protection)
        const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Check if already authenticated
        function checkAuth() {
            // Skip password protection in local development
            if (isLocalDev) {
                showDashboard();
                return;
            }

            const authenticated = sessionStorage.getItem(AUTH_KEY);
            if (authenticated === 'true') {
                showDashboard();
            } else {
                showPasswordScreen();
            }
        }

        // Show password screen
        function showPasswordScreen() {
            document.getElementById('password-protection-overlay').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('authenticated');
            document.getElementById('password-input').focus();
        }

        // Show dashboard
        function showDashboard() {
            document.getElementById('password-protection-overlay').classList.add('hidden');
            document.getElementById('main-content').classList.add('authenticated');
            sessionStorage.setItem(AUTH_KEY, 'true');
        }

        // Check password on form submit
        function checkPassword(event) {
            event.preventDefault();
            const input = document.getElementById('password-input');
            const errorDiv = document.getElementById('password-error');
            const enteredPassword = (input.value || '').trim();

            if (enteredPassword === DASHBOARD_PASSWORD) {
                errorDiv.classList.remove('show');
                showDashboard();
            } else {
                errorDiv.classList.add('show');
                input.value = '';
                input.focus();
                // Shake animation
                input.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    input.style.animation = '';
                }, 500);
            }
        }

        // Add shake animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(style);

        // Run auth when DOM is ready (so overlay/main-content exist)
        function initAuth() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkAuth);
            } else {
                checkAuth();
            }
        }
        initAuth();

        // Allow Enter key to submit
        document.addEventListener('DOMContentLoaded', function () {
            const passwordInput = document.getElementById('password-input');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        checkPassword(e);
                    }
                });
            }
        });

        // Original script continues...
        // Set default dates
        const today = new Date();
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);

        document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
        document.getElementById('endDate').valueAsDate = today;

        // Get API base URL (use local backend in dev, Vercel in production)
        // isLocalDev is already defined above for password protection
        const API_BASE = isLocalDev ? 'http://localhost:8000/api' : (window.location.origin + '/api');

        // Load and display version
        fetch('/version.txt')
            .then(response => response.text())
            .then(version => {
                const versionDisplay = document.getElementById('versionDisplay');
                if (versionDisplay) {
                    versionDisplay.textContent = `Build v${version.trim()}`;
                }
            })
            .catch(() => {
                // If version file doesn't exist, keep default
            });

        // Protection bypass secret (if available)
        // Can be passed via URL parameter: ?x-vercel-protection-bypass=SECRET
        // Or set the default secret here (for convenience, but note: this exposes it in client-side code)
        const BYPASS_SECRET = new URLSearchParams(window.location.search).get('x-vercel-protection-bypass')
            || '6962f381c54d41d6de8fb303645c938dd6b4ff6870f3854c9e972a214530f474';

        // Helper function to add bypass to requests
        function getApiUrl(endpoint, params = {}) {
            const url = new URL(API_BASE + endpoint, window.location.origin);
            Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
            if (BYPASS_SECRET) {
                url.searchParams.append('x-vercel-protection-bypass', BYPASS_SECRET);
                url.searchParams.append('x-vercel-set-bypass-cookie', 'true');
            }
            return url.toString();
        }

        // Helper function for fetch with bypass
        async function fetchWithBypass(url, options = {}) {
            const headers = new Headers(options.headers || {});
            if (BYPASS_SECRET) {
                headers.set('x-vercel-protection-bypass', BYPASS_SECRET);
            }
            // Add bypass to URL as well (required by Vercel)
            const urlObj = new URL(url, window.location.origin);
            if (BYPASS_SECRET) {
                urlObj.searchParams.set('x-vercel-protection-bypass', BYPASS_SECRET);
                urlObj.searchParams.set('x-vercel-set-bypass-cookie', 'true');
            }
            return fetch(urlObj.toString(), { ...options, headers });
        }

        async function loadData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
            const sections = Array.from(checkboxes).map(cb => cb.value);

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading data...</div>';

            // Store sections by name for tabbed interface
            const sectionsData = {};
            const chartRenderers = []; // Store chart rendering functions

            // Add cache-busting timestamp to ensure fresh data
            const timestamp = new Date().getTime();

            // Overview
            if (sections.includes('Overview')) {
                try {
                    const url = getApiUrl('/analytics/overview', { start_date: startDate, end_date: endDate });
                    const response = await fetchWithBypass(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Overview error:', response.status, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.success && result.data) {
                        const stats = result.data;
                        sectionsData['Overview'] = `
                            <div class="section">
                                <h2>Traffic Overview</h2>
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Total Sessions', tooltips['Total Sessions'])}</div>
                                        <div class="metric-value">${formatNumber(stats.sessions || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Total Users', tooltips['Total Users'])}</div>
                                        <div class="metric-value">${formatNumber(stats.totalUsers || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Page Views', tooltips['Page Views'])}</div>
                                        <div class="metric-value">${formatNumber(stats.screenPageViews || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Engagement Rate', tooltips['Engagement Rate'])}</div>
                                        <div class="metric-value">${((stats.engagementRate || 0) * 100).toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    const errorMsg = error.message || 'Unknown error';
                    sectionsData['Overview'] = `<div class="error">Error loading overview: ${errorMsg}</div>`;
                    console.error('Overview error details:', error);
                }
            }

            // Traffic Sources
            if (sections.includes('Traffic Sources')) {
                try {
                    const url = getApiUrl('/analytics/sources', { start_date: startDate, end_date: endDate, limit: 10, _t: timestamp });
                    const response = await fetchWithBypass(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Sources error:', response.status, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        sectionsData['Traffic Sources'] = `
                            <div class="section">
                                <h2>Traffic Sources</h2>
                                <div id="sourcesChart"></div>
                            </div>
                        `;
                        // Store chart renderer
                        chartRenderers.push(() => {
                            const data = result.data.map(d => ({ name: d.sessionSourceMedium, value: parseInt(d.sessions) }));
                            // Sort by value to ensure largest slices get most distinct colors
                            const sortedData = [...data].sort((a, b) => b.value - a.value);
                            // Use very distinct colors - orange for brand, blue for second, then varied colors
                            const colorPalette = ['#ff5800', '#4a90e2', '#50c878', '#f39c12', '#9b59b6', '#e74c3c', '#1abc9c', '#34495e', '#e67e22', '#16a085'];
                            // Map colors to sorted data, then reorder to original data order
                            const colorMap = new Map();
                            sortedData.forEach((item, idx) => {
                                colorMap.set(item.name, colorPalette[idx % colorPalette.length]);
                            });
                            const colors = data.map(d => colorMap.get(d.name));
                            Plotly.newPlot('sourcesChart', [{
                                values: data.map(d => d.value),
                                labels: data.map(d => d.name),
                                type: 'pie',
                                marker: { colors: colors }
                            }], {
                                title: 'Sessions by Source',
                                font: { family: 'Roboto' }
                            });
                        });
                    }
                } catch (error) {
                    const errorMsg = error.message || 'Unknown error';
                    sectionsData['Traffic Sources'] = `<div class="error">Error loading sources: ${errorMsg}</div>`;
                    console.error('Sources error details:', error);
                }
            }

            // Top Pages
            if (sections.includes('Top Pages')) {
                try {
                    const url = getApiUrl('/analytics/pages', { start_date: startDate, end_date: endDate, limit: 20, _t: timestamp });
                    const response = await fetchWithBypass(url);
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Pages error:', response.status, errorText);
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        sectionsData['Top Pages'] = `
                            <div class="section">
                                <h2>Top Pages</h2>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>${createTooltip('Page Title', tooltips['Page Title'])}</th>
                                            <th>${createTooltip('Path', tooltips['Path'])}</th>
                                            <th>${createTooltip('Views', tooltips['Views'])}</th>
                                            <th>${createTooltip('Users', tooltips['Users'])}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.data.map(page => `
                                            <tr>
                                                <td>${page.pageTitle || 'N/A'}</td>
                                                <td>${page.pagePath || 'N/A'}</td>
                                                <td>${formatNumber(page.screenPageViews || 0)}</td>
                                                <td>${formatNumber(page.activeUsers || 0)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } catch (error) {
                    const errorMsg = error.message || 'Unknown error';
                    sectionsData['Top Pages'] = `<div class="error">Error loading pages: ${errorMsg}</div>`;
                    console.error('Pages error details:', error);
                }
            }

            // User Retention
            if (sections.includes('User Retention')) {
                try {
                    const url = getApiUrl('/analytics/retention', { start_date: startDate, end_date: endDate, _t: timestamp });
                    const response = await fetchWithBypass(url);
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        sectionsData['User Retention'] = `
                            <div class="section">
                                <h2>User Retention</h2>
                                <div id="retentionChart"></div>
                            </div>
                        `;
                        // Store chart renderer
                        chartRenderers.push(() => {
                            const data = result.data.map(d => ({ name: d.newVsReturning, value: parseInt(d.sessions) }));
                            Plotly.newPlot('retentionChart', [{
                                values: data.map(d => d.value),
                                labels: data.map(d => d.name),
                                type: 'pie',
                                marker: { colors: ['#ff5800', '#4a90e2', '#50c878', '#f39c12'] }
                            }], {
                                title: 'New vs Returning Users',
                                font: { family: 'Roboto' }
                            });
                        });
                    }
                } catch (error) {
                    sectionsData['User Retention'] = `<div class="error">Error loading retention: ${error.message}</div>`;
                }
            }

            // Geographics (Cities and Countries)
            if (sections.includes('Geographics')) {
                try {
                    // Cities
                    const citiesUrl = getApiUrl('/analytics/cities', { start_date: startDate, end_date: endDate, limit: 10, _t: timestamp });
                    const citiesResponse = await fetchWithBypass(citiesUrl);
                    const citiesResult = await citiesResponse.json();

                    // Countries
                    const countriesUrl = getApiUrl('/analytics/countries', { start_date: startDate, end_date: endDate, _t: timestamp });
                    const countriesResponse = await fetchWithBypass(countriesUrl);
                    const countriesResult = await countriesResponse.json();

                    if ((citiesResult.success && citiesResult.data && citiesResult.data.length > 0) ||
                        (countriesResult.success && countriesResult.data && countriesResult.data.length > 0)) {
                        let geoHTML = `
                            <div class="section">
                                <h2>Geographic Distribution</h2>
                        `;

                        if (citiesResult.success && citiesResult.data && citiesResult.data.length > 0) {
                            geoHTML += `
                                <h3 style="margin-top: 1rem; margin-bottom: 1rem;">Top Cities</h3>
                                <table style="margin-bottom: 2rem;">
                                    <thead>
                                        <tr>
                                            <th>City</th>
                                            <th>Sessions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${citiesResult.data.map(city => `
                                            <tr>
                                                <td>${city.city || 'N/A'}</td>
                                                <td>${formatNumber(city.sessions || 0)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        }

                        if (countriesResult.success && countriesResult.data && countriesResult.data.length > 0) {
                            geoHTML += `
                                <h3 style="margin-top: 1rem; margin-bottom: 1rem;">Top Countries</h3>
                                <div id="countriesChart"></div>
                            `;
                            // Store chart renderer
                            chartRenderers.push(() => {
                                const topCountries = countriesResult.data.slice(0, 10);
                                Plotly.newPlot('countriesChart', [{
                                    x: topCountries.map(c => c.country),
                                    y: topCountries.map(c => parseInt(c.sessions)),
                                    type: 'bar',
                                    marker: { color: '#ff5800' }
                                }], {
                                    title: 'Sessions by Country (Top 10)',
                                    xaxis: { title: 'Country' },
                                    yaxis: { title: 'Sessions' },
                                    font: { family: 'Roboto' }
                                });
                            });
                        }

                        geoHTML += `</div>`;
                        sectionsData['Geographics'] = geoHTML;
                    }
                } catch (error) {
                    sectionsData['Geographics'] = `<div class="error">Error loading geographics: ${error.message}</div>`;
                }
            }

            // Tech/Devices
            if (sections.includes('Tech/Devices')) {
                try {
                    const url = getApiUrl('/analytics/devices', { start_date: startDate, end_date: endDate });
                    const response = await fetchWithBypass(url);
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        sectionsData['Tech/Devices'] = `
                            <div class="section">
                                <h2>Device Categories</h2>
                                <div id="devicesChart"></div>
                            </div>
                        `;
                        // Store chart renderer
                        chartRenderers.push(() => {
                            const data = result.data.map(d => ({ name: d.deviceCategory, value: parseInt(d.sessions) }));
                            Plotly.newPlot('devicesChart', [{
                                values: data.map(d => d.value),
                                labels: data.map(d => d.name),
                                type: 'pie',
                                marker: { colors: ['#ff5800', '#4a90e2', '#50c878', '#f39c12'] }
                            }], {
                                title: 'Sessions by Device Category',
                                font: { family: 'Roboto' }
                            });
                        });
                    }
                } catch (error) {
                    sectionsData['Tech/Devices'] = `<div class="error">Error loading devices: ${error.message}</div>`;
                }
            }

            // Events
            if (sections.includes('Events')) {
                try {
                    const url = getApiUrl('/analytics/events', { start_date: startDate, end_date: endDate, limit: 20, _t: timestamp });
                    const response = await fetchWithBypass(url);
                    const result = await response.json();
                    if (result.success && result.data && result.data.length > 0) {
                        sectionsData['Events'] = `
                            <div class="section">
                                <h2>Top Events</h2>
                                <div id="eventsChart"></div>
                                <table style="margin-top: 2rem;">
                                    <thead>
                                        <tr>
                                            <th>${createTooltip('Event Name', tooltips['Event Name'])}</th>
                                            <th>${createTooltip('Event Count', tooltips['Event Count'] || tooltips['Count'])}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.data.map(event => `
                                            <tr>
                                                <td>${event.eventName || 'N/A'}</td>
                                                <td>${formatNumber(event.eventCount || 0)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        // Store chart renderer
                        chartRenderers.push(() => {
                            const topEvents = result.data.slice(0, 10);
                            Plotly.newPlot('eventsChart', [{
                                x: topEvents.map(e => e.eventName),
                                y: topEvents.map(e => parseInt(e.eventCount)),
                                type: 'bar',
                                marker: { color: '#ff5800' }
                            }], {
                                title: 'Top Events (Top 10)',
                                xaxis: { title: 'Event Name', tickangle: -45 },
                                yaxis: { title: 'Event Count' },
                                font: { family: 'Roboto' }
                            });
                        });
                    }
                } catch (error) {
                    sectionsData['Events'] = `<div class="error">Error loading events: ${error.message}</div>`;
                }
            }

            // Business Profile (API: /api/gbp/ratings, /api/gbp/reviews, /api/gbp/insights)
            if (sections.includes('Business Profile')) {
                try {
                    const ratingsUrl = getApiUrl('/gbp/ratings', { _t: timestamp });
                    const ratingsResponse = await fetchWithBypass(ratingsUrl);
                    const reviewsUrl = getApiUrl('/gbp/reviews', { _t: timestamp });
                    const reviewsResponse = await fetchWithBypass(reviewsUrl);
                    const insightsUrl = getApiUrl('/gbp/insights', { start_date: startDate, end_date: endDate, _t: timestamp });
                    const insightsResponse = await fetchWithBypass(insightsUrl);

                    let ratingsResult = { success: false, data: {} };
                    let reviewsResult = { success: false, data: [], reviews: [] };
                    let insightsResult = { success: false, summary: {} };
                    let bpError = '';
                    try {
                        ratingsResult = ratingsResponse.ok ? await ratingsResponse.json() : { success: false, data: {}, error: (await ratingsResponse.text()) || 'Request failed ' + ratingsResponse.status };
                        if (!ratingsResponse.ok && typeof ratingsResult === 'string') ratingsResult = { success: false, error: ratingsResult };
                    } catch (e) { bpError = bpError || ('Ratings: ' + (e.message || 'parse error')); }
                    try {
                        reviewsResult = reviewsResponse.ok ? await reviewsResponse.json() : { success: false, data: [], reviews: [], error: (await reviewsResponse.text()) || 'Request failed ' + reviewsResponse.status };
                        if (!reviewsResponse.ok && typeof reviewsResult === 'string') reviewsResult = { success: false, error: reviewsResult };
                    } catch (e) { bpError = bpError || ('Reviews: ' + (e.message || 'parse error')); }
                    try {
                        insightsResult = insightsResponse.ok ? await insightsResponse.json() : { success: false, summary: {}, error: (await insightsResponse.text()) || 'Request failed ' + insightsResponse.status };
                        if (!insightsResponse.ok && typeof insightsResult === 'string') insightsResult = { success: false, error: insightsResult };
                    } catch (e) { bpError = bpError || ('Insights: ' + (e.message || 'parse error')); }

                    const apiError = ratingsResult.error || reviewsResult.error || insightsResult.error || bpError || (ratingsResult.detail || reviewsResult.detail || insightsResult.detail);

                    let bpHTML = `
                        <div class="section">
                            <h2>Google Business Profile</h2>
                    `;

                    // API error display removed - reviews are disabled, only insights shown

                    // Connected state: all three API calls succeeded (no apiError)
                    const gbpConnected = !apiError && ratingsResult.success && reviewsResult.success && insightsResult.success;
                    if (gbpConnected && !(ratingsResult.data && ratingsResult.data.totalReviews > 0)) {
                        bpHTML += `
                            <div style="padding: 1rem; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 6px; margin-bottom: 1rem;">
                                <p style="color: #155724; margin: 0;">‚úì Business Profile is connected. No reviews or insights data for this location yet (or none in the selected date range).</p>
                            </div>
                        `;
                    }

                    // Ratings Summary
                    if (ratingsResult.success && ratingsResult.data && ratingsResult.data.totalReviews > 0) {
                        const ratings = ratingsResult.data;
                        bpHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Ratings Summary</h3>
                                <div class="metrics-grid" style="margin-bottom: 1.5rem;">
                                    <div class="metric-card">
                                        <div class="metric-label">Average Rating</div>
                                        <div class="metric-value">${ratings.averageRating.toFixed(1)} ‚≠ê</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">Total Reviews</div>
                                        <div class="metric-value">${formatNumber(ratings.totalReviews)}</div>
                                    </div>
                                </div>
                                <div id="ratingsChart" style="width: 100%; height: 300px; margin-bottom: 2rem;"></div>
                            </div>
                        `;

                        // Store chart renderer for ratings distribution
                        chartRenderers.push(() => {
                            const dist = ratings.ratingDistribution;
                            Plotly.newPlot('ratingsChart', [{
                                x: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                                y: [dist['1'] || 0, dist['2'] || 0, dist['3'] || 0, dist['4'] || 0, dist['5'] || 0],
                                type: 'bar',
                                marker: { color: ['#e74c3c', '#f39c12', '#f1c40f', '#3498db', '#2ecc71'] }
                            }], {
                                title: 'Rating Distribution',
                                xaxis: { title: 'Rating' },
                                yaxis: { title: 'Number of Reviews' },
                                font: { family: 'Roboto' }
                            });
                        });
                    } else if (!apiError && !gbpConnected) {
                        bpHTML += `
                            <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; margin-bottom: 2rem;">
                                <p style="color: #856404; margin: 0;">‚ö†Ô∏è Business Profile not configured or no reviews yet. Add credentials (see GBP_README.md).</p>
                            </div>
                        `;
                    }

                    // Recent Reviews (API returns .data or .reviews)
                    const reviewsList = reviewsResult.data || reviewsResult.reviews || [];
                    if (reviewsResult.success && reviewsList.length > 0) {
                        const reviews = reviewsList;
                        bpHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Recent Reviews</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Rating</th>
                                            <th>Reviewer</th>
                                            <th>Comment</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;

                        reviews.slice(0, 10).forEach(review => {
                            const reviewDate = (review.createTime || review.updateTime) ? new Date(review.createTime || review.updateTime).toLocaleDateString() : '‚Äî';
                            const starRating = review.starRating ?? review.rating ?? 0;
                            const stars = '‚≠ê'.repeat(starRating);
                            const comment = (review.comment || '').substring(0, 100) + (review.comment && review.comment.length > 100 ? '...' : '');
                            const reviewerName = (review.reviewer && review.reviewer.displayName) || review.reviewer || 'Anonymous';
                            bpHTML += `
                                <tr>
                                    <td>${reviewDate}</td>
                                    <td>${stars} (${starRating})</td>
                                    <td>${reviewerName}</td>
                                    <td>${comment || 'No comment'}</td>
                                </tr>
                            `;
                        });

                        bpHTML += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }

                    // Insights (API returns .summary with views and customerActions) ‚Äì show even when 0 if connected
                    const insightsSummary = insightsResult.summary || insightsResult.data || {};
                    if (insightsResult.success && insightsSummary.views) {
                        const insights = insightsSummary;
                        const hasAnyInsight = (insights.views.search || 0) + (insights.views.maps || 0) + (insights.customerActions?.websiteClicks || 0) + (insights.customerActions?.directionRequests || 0) > 0;
                        bpHTML += `
                            <div style="margin-bottom: 2rem;">
                                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Business Insights</h3>
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Search Views', tooltips['Search Views'])}</div>
                                        <div class="metric-value">${formatNumber(insights.views.search || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Maps Views', tooltips['Maps Views'])}</div>
                                        <div class="metric-value">${formatNumber(insights.views.maps || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Website Clicks', tooltips['Website Clicks'])}</div>
                                        <div class="metric-value">${formatNumber(insights.customerActions?.websiteClicks || 0)}</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-label">${createTooltip('Direction Requests', tooltips['Direction Requests'])}</div>
                                        <div class="metric-value">${formatNumber(insights.customerActions?.directionRequests || 0)}</div>
                                    </div>
                                </div>
                                ${!hasAnyInsight ? '<p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 0.5rem;">No activity in the selected date range.</p>' : ''}
                            </div>
                        `;
                    }

                    bpHTML += `</div>`;
                    sectionsData['Business Profile'] = bpHTML;
                } catch (error) {
                    sectionsData['Business Profile'] = `<div class="error">Error loading Business Profile data: ${error.message}</div>`;
                }
            }

            // Build tabbed interface if we have sections
            const sectionOrder = ['Overview', 'Traffic Sources', 'Top Pages', 'User Retention', 'Geographics', 'Tech/Devices', 'Events', 'Business Profile'];
            const availableSections = sectionOrder.filter(s => sections.includes(s) && sectionsData[s]);

            let finalHTML = '';

            if (availableSections.length > 0) {
                // Build tabs HTML
                finalHTML = '<div class="tabs-container">';
                finalHTML += '<div class="tabs-header">';

                availableSections.forEach((section, index) => {
                    const tabId = `tab-${section.toLowerCase().replace(/\s+/g, '-').replace(/\//g, '-')}`;
                    const isActive = index === 0 ? 'active' : '';
                    finalHTML += `<button class="tab-button ${isActive}" onclick="switchTab('${tabId}')" data-tab="${tabId}">${section}</button>`;
                });

                finalHTML += '</div>';

                // Add tab panels
                availableSections.forEach((section, index) => {
                    const tabId = `tab-${section.toLowerCase().replace(/\s+/g, '-').replace(/\//g, '-')}`;
                    const isActive = index === 0 ? 'active' : '';
                    const sectionHTML = sectionsData[section] || '';
                    finalHTML += `<div class="tab-panel ${isActive}" id="${tabId}">${sectionHTML}</div>`;
                });

                finalHTML += '</div>';
            } else {
                finalHTML = '<div class="loading">No data available for selected sections</div>';
            }

            // Set HTML first
            content.innerHTML = finalHTML;

            // Then render all charts after DOM is ready
            setTimeout(() => {
                chartRenderers.forEach(renderer => {
                    try {
                        renderer();
                    } catch (error) {
                        console.error('Error rendering chart:', error);
                    }
                });
            }, 200);
        }

        // Tab switching function
        function switchTab(tabId) {
            // Prevent any scrolling
            const scrollY = window.scrollY;

            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected tab panel
            const selectedPanel = document.getElementById(tabId);
            if (selectedPanel) {
                selectedPanel.classList.add('active');
            }

            // Add active class to clicked button
            const clickedButton = document.querySelector(`[data-tab="${tabId}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            // Restore scroll position
            window.scrollTo(0, scrollY);
        }

        // Navigation menu switching function
        function showNavSection(sectionId, event) {
            // Prevent any scrolling
            const scrollY = window.scrollY;

            // Hide all content sections
            document.querySelectorAll('.nav-content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId + '-section');
            if (selectedSection) {
                selectedSection.classList.add('active');
            }

            // Add active class to clicked nav item
            if (event && event.target) {
                event.target.classList.add('active');
            }

            // Restore scroll position
            window.scrollTo(0, scrollY);
        }

        // Tooltip definitions - initialize with fallback, then load from keyterms.json
        const tooltips = {
            'Total Sessions': 'Total number of visits to the site in this period. One person can create multiple sessions if they return.',
            'Total Users': 'Estimated number of unique people who visited the site in this period.',
            'Page Views': 'Total times any page on the site was loaded or viewed, including repeats.',
            'Engagement Rate': 'Percent of sessions where visitors did something meaningful, like viewing multiple pages, staying a while, or triggering key events.',
            'Avg. Session Duration': 'Average time visitors actively spent on the site during a visit.',
            'Bounce Rate': 'Percent of sessions where visitors left after only one page with no meaningful interaction.',
            'Source / Medium': 'Source is the specific origin, like google.com or BenchmarkEmail. Medium is the traffic type, such as organic search, referral, email, or direct.',
            'Sessions by Source': 'Shows how many visits came from each traffic source and medium combination.',
            '(direct) / (none)': 'Visits where Analytics could not detect a referrer. Often people typing the URL, using bookmarks, or clicking untagged links in apps, PDFs, or emails.',
            'google / organic': 'Unpaid clicks from Google search results.',
            'bing / organic': 'Unpaid clicks from Bing search results.',
            'duckduckgo / organic': 'Unpaid clicks from DuckDuckGo search results.',
            'BenchmarkEmail / email': 'Visits from links in Benchmark Email campaigns that have tracking tags.',
            'Views': 'How many times this page or product was viewed in the selected period.',
            'Users': 'How many unique visitors viewed this page or product at least once.',
            'Page Title': 'The title of the page as it appears in the browser tab.',
            'Path': 'The URL path of the page on the website.',
            'New Users': 'People visiting the site for the first time on this device or browser.',
            'Returning Users': 'People who have visited before on this device or browser and came back in this period.',
            'Sessions by Country': 'Where visits originated, based on IP location; some traffic may be "not set" if location is unclear.',
            'Top Cities': 'Cities that generated the most sessions in the selected period.',
            'Device Category': 'Type of device used for the visit, such as desktop, mobile, or tablet.',
            'desktop': 'Sessions from laptop or desktop computers.',
            'mobile': 'Sessions from smartphones.',
            'tablet': 'Sessions from tablet devices.',
            'Event Name': 'A specific action that was tracked on the site, such as viewing a page, scrolling, or submitting a form.',
            'Event Count': 'Total number of times this event was recorded in the selected period.',
            'Count': 'Number of times this event occurred in the selected period.',
            'page_view': 'Recorded whenever a page on the site loads or is viewed.',
            'user_engagement': 'Recorded when a visitor has an engaged session, for example staying on a page long enough or interacting before leaving.',
            'session_start': 'Recorded when a new visit to the site begins.',
            'first_visit': 'Recorded the first time a device or browser ever visits the site.',
            'scroll': 'Recorded when a visitor scrolls far enough down a page to show they viewed more than just the top.',
            'form_start': 'Recorded when someone begins filling out a tracked form.',
            'form_submit': 'Recorded when someone successfully submits a tracked form.',
            'click': 'Recorded when a tracked button or link is clicked.',
            'file_download': 'Recorded when a visitor downloads a tracked file, such as a PDF or brochure.',
            'click_buy_online': 'Recorded when a visitor clicks a tracked "buy online" or similar outbound purchase link.',
            'Search Views': 'Number of times your business appeared in Google Search results.',
            'Maps Views': 'Number of times your business appeared on Google Maps.',
            'Website Clicks': 'Number of clicks to your website from your Google Business Profile.',
            'Direction Requests': 'Number of requests for driving directions to your business location.'
        };

        // Load additional tooltips from keyterms.json and merge
        fetch('/keyterms.json')
            .then(response => response.json())
            .then(data => {
                // Convert keyterms.json format to tooltips object and merge
                Object.values(data).forEach(term => {
                    tooltips[term.label] = term.description;
                });
            })
            .catch(error => {
                console.warn('Could not load keyterms.json, using fallback definitions:', error);
            });

        // Helper function to create tooltip HTML
        function createTooltip(label, tooltipText) {
            if (!tooltipText) return label;
            return `
                <span class="tooltip-trigger">
                    ${label}
                    <span class="tooltip-icon">?</span>
                    <span class="tooltip">${tooltipText}</span>
                </span>
            `;
        }

        function formatNumber(num) {
            const n = parseFloat(num) || 0;
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toLocaleString();
        }

        async function generateReport() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Read checkboxes fresh each time
            const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
            const sections = Array.from(checkboxes).map(cb => {
                const value = cb.value;
                console.log('Found checked checkbox:', value, 'checked:', cb.checked);
                return value;
            });

            console.log('Checked sections array:', sections); // Debug log
            console.log('Number of checked boxes:', checkboxes.length); // Debug log

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            if (sections.length === 0) {
                alert('Please select at least one section to include in the report');
                return;
            }

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Generating report...</div>';

            try {
                // Fetch data only for checked sections with cache-busting timestamp
                const timestamp = new Date().getTime();
                const fetchPromises = [];
                const fetchKeys = [];

                // Always fetch overview for Executive Summary
                fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/overview', { start_date: startDate, end_date: endDate, _t: timestamp })));
                fetchKeys.push('overview');

                if (sections.includes('Traffic Sources')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/sources', { start_date: startDate, end_date: endDate, limit: 10, _t: timestamp })));
                    fetchKeys.push('sources');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('sources');
                }

                if (sections.includes('Top Pages')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/pages', { start_date: startDate, end_date: endDate, limit: 20, _t: timestamp })));
                    fetchKeys.push('pages');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('pages');
                }

                if (sections.includes('User Retention')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/retention', { start_date: startDate, end_date: endDate, _t: timestamp })));
                    fetchKeys.push('retention');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('retention');
                }

                if (sections.includes('Geographics')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/cities', { start_date: startDate, end_date: endDate, limit: 10, _t: timestamp })));
                    fetchKeys.push('cities');
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/countries', { start_date: startDate, end_date: endDate, _t: timestamp })));
                    fetchKeys.push('countries');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('cities');
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('countries');
                }

                if (sections.includes('Tech/Devices')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/devices', { start_date: startDate, end_date: endDate, _t: timestamp })));
                    fetchKeys.push('devices');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('devices');
                }

                if (sections.includes('Events')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/analytics/events', { start_date: startDate, end_date: endDate, limit: 20, _t: timestamp })));
                    fetchKeys.push('events');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('events');
                }

                if (sections.includes('Business Profile')) {
                    fetchPromises.push(fetchWithBypass(getApiUrl('/gbp/insights', { start_date: startDate, end_date: endDate, _t: timestamp })));
                    fetchKeys.push('gbpInsights');
                } else {
                    fetchPromises.push(Promise.resolve(null));
                    fetchKeys.push('gbpInsights');
                }

                const responses = await Promise.all(fetchPromises);

                // Capture timestamp when data was collected from API
                const dataCollectionTime = new Date();

                // Parse responses - handle null responses for unchecked sections
                const overview = responses[0] && responses[0] !== null && responses[0].ok ? await responses[0].json() : { success: false, data: {} };
                const sources = responses[1] && responses[1] !== null && responses[1].ok ? await responses[1].json() : { success: false, data: [] };
                const pages = responses[2] && responses[2] !== null && responses[2].ok ? await responses[2].json() : { success: false, data: [] };
                const retention = responses[3] && responses[3] !== null && responses[3].ok ? await responses[3].json() : { success: false, data: [] };
                const cities = responses[4] && responses[4] !== null && responses[4].ok ? await responses[4].json() : { success: false, data: [] };
                const countries = responses[5] && responses[5] !== null && responses[5].ok ? await responses[5].json() : { success: false, data: [] };
                const devices = responses[6] && responses[6] !== null && responses[6].ok ? await responses[6].json() : { success: false, data: [] };
                const events = responses[7] && responses[7] !== null && responses[7].ok ? await responses[7].json() : { success: false, data: [] };
                const gbpInsights = responses[8] && responses[8] !== null && responses[8].ok ? await responses[8].json() : { success: false, summary: {} };


                // Format dates
                const start = new Date(startDate);
                const end = new Date(endDate);
                const monthName = start.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Format date to DD/MM/YYYY
                function formatDateDDMMYYYY(dateString) {
                    const date = new Date(dateString);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }

                // Format date and time to DD/MM/YYYY HH:MM
                function formatDateTimeDDMMYYYYHHMM(date) {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${day}/${month}/${year} ${hours}:${minutes}`;
                }

                const formattedStartDate = formatDateDDMMYYYY(startDate);
                const formattedEndDate = formatDateDDMMYYYY(endDate);
                const formattedCollectionTime = formatDateTimeDDMMYYYYHHMM(dataCollectionTime);

                // Calculate percentages
                const totalSessions = parseFloat(overview.data.sessions || 0);
                const totalSourceSessions = sources.data.reduce((sum, s) => sum + parseFloat(s.sessions || 0), 0);

                // Find search events
                const searchEvents = events.data.filter(e =>
                    e.eventName && (e.eventName.toLowerCase().includes('search') || e.eventName.toLowerCase().includes('query'))
                );

                // Filter product pages
                const productPages = pages.data.filter(p =>
                    p.pagePath && (p.pagePath.includes('/product/') || p.pagePath.includes('/product-category/'))
                );

                // Generate report HTML - A4 size: 210mm x 297mm (8.27" x 11.69")
                // For web display, we'll use ~794px width (A4 width at 96 DPI)
                let reportHtml = `
                    <div class="section" style="max-width: 794px; width: 794px; margin: 0 auto; background: white; padding: 20px; box-sizing: border-box;" id="reportContainer">
                        <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #ff5800;">
                            <img src="https://www.tenacioustapes.com.au/wp-content/uploads/2025/12/tenacious-tapes-logo-scaled.png" alt="Tenacious Tapes Logo" class="report-logo" style="height: 60px; max-height: 60px; width: auto; max-width: 200px; margin-bottom: 1rem;">
                            <h1 style="color: #2c3e50; margin-bottom: 0.5rem;">Monthly Website Analytics Report</h1>
                            <p style="color: #7f8c8d; font-size: 1.1rem;"><strong>${monthName}</strong></p>
                            <p style="color: #7f8c8d; margin-bottom: 0.25rem;">Period: ${formattedStartDate} to ${formattedEndDate}</p>
                            <p style="color: #7f8c8d; font-size: 0.9rem; font-style: italic;">Data collected: ${formattedCollectionTime}</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #e0e0e0; box-sizing: border-box;">
                            <h2 style="color: #ff5800; margin-bottom: 1rem; font-size: 1.5rem;">Executive Summary</h2>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;"><strong>Total Sessions:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${formatNumber(overview.data.sessions || 0)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; box-sizing: border-box;"><strong>Total Users:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${formatNumber(overview.data.totalUsers || 0)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; box-sizing: border-box;"><strong>Page Views:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${formatNumber(overview.data.screenPageViews || 0)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; box-sizing: border-box;"><strong>Engagement Rate:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${((overview.data.engagementRate || 0) * 100).toFixed(1)}%</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; box-sizing: border-box;"><strong>Avg. Session Duration:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${Math.round(overview.data.averageSessionDuration || 0)}s</td>
                                </tr>
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; box-sizing: border-box;"><strong>Bounce Rate:</strong></td>
                                    <td style="padding: 0.75rem; border: 1px solid #ddd; font-size: 1.1rem; box-sizing: border-box;">${((overview.data.bounceRate || 0) * 100).toFixed(1)}%</td>
                                </tr>
                            </table>
                        </div>
                `;

                // Section counter for numbering
                let sectionNum = 1;

                // 1. Traffic Sources (only if checked)
                if (sections.includes('Traffic Sources')) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section" data-is-first-section="true">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Traffic Sources</h2>
                            <div id="reportSourcesChart" style="width: 100%; height: 400px; margin-bottom: 3rem; padding-bottom: 2rem; box-sizing: border-box; overflow: visible;"></div>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 50%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Source</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Percentage</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Sessions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                    if (sources.data && sources.data.length > 0) {
                        sources.data.forEach(source => {
                            const pct = totalSourceSessions > 0 ? ((parseFloat(source.sessions) / totalSourceSessions) * 100).toFixed(1) : 0;
                            reportHtml += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;">${source.sessionSourceMedium || 'N/A'}</td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>${pct}%</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(source.sessions || 0)}</td>
                            </tr>
                        `;
                        });
                    } else {
                        reportHtml += '<tr><td colspan="3">No source data available</td></tr>';
                    }

                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 2. Most Visited Areas (only if Top Pages is checked)
                if (sections.includes('Top Pages')) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Top Pages</h2>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 35%;">
                                    <col style="width: 30%;">
                                    <col style="width: 17.5%;">
                                    <col style="width: 17.5%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Page Title</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Path</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Views</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Users</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                    if (pages.data && pages.data.length > 0) {
                        pages.data.slice(0, 15).forEach(page => {
                            reportHtml += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;"><strong>${page.pageTitle || 'N/A'}</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; font-family: monospace; font-size: 0.9rem; color: #7f8c8d; box-sizing: border-box; word-wrap: break-word; overflow-wrap: break-word;">${page.pagePath || 'N/A'}</td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(page.screenPageViews || 0)}</td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(page.activeUsers || 0)}</td>
                            </tr>
                        `;
                        });
                    } else {
                        reportHtml += '<tr><td colspan="4">No page data available</td></tr>';
                    }

                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 3. Most Searched Products (only if Top Pages is checked and we have product pages)
                if (sections.includes('Top Pages') && productPages.length > 0) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Most Searched Products</h2>
                    `;

                    if (productPages.length > 0) {
                        reportHtml += `
                        <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                            <colgroup>
                                <col style="width: 60%;">
                                <col style="width: 20%;">
                                <col style="width: 20%;">
                            </colgroup>
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Product</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Views</th>
                                    <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Users</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                        productPages.slice(0, 10).forEach(product => {
                            reportHtml += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;"><strong>${product.pageTitle || 'N/A'}</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(product.screenPageViews || 0)}</td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(product.activeUsers || 0)}</td>
                            </tr>
                        `;
                        });
                        reportHtml += `</tbody></table>`;
                    } else {
                        reportHtml += '<p style="color: #7f8c8d;">No product page data available for this period.</p>';
                    }

                    reportHtml += `
                        </div>
                    `;
                }

                // 4. User Retention (only if checked)
                if (sections.includes('User Retention') && retention.data && retention.data.length > 0) {
                    const newUsers = retention.data.find(r => r.newVsReturning === 'new');
                    const returningUsers = retention.data.find(r => r.newVsReturning === 'returning');
                    const newPct = newUsers ? ((parseFloat(newUsers.sessions) / totalSessions) * 100).toFixed(1) : 0;
                    const returnPct = returningUsers ? ((parseFloat(returningUsers.sessions) / totalSessions) * 100).toFixed(1) : 0;
                    const newSessions = newUsers ? parseFloat(newUsers.sessions) : 0;
                    const returnSessions = returningUsers ? parseFloat(returningUsers.sessions) : 0;
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. User Retention</h2>
                            <div id="reportRetentionChart" style="width: 100%; height: 400px; margin-bottom: 3rem; padding-bottom: 2rem; box-sizing: border-box;"></div>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 50%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">User Type</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Percentage</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Sessions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>New Users</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>${newPct}%</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(newSessions)}</td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>Returning Users</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>${returnPct}%</strong></td>
                                        <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(returnSessions)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 5. Geographic Distribution (only if checked)
                if (sections.includes('Geographics') && (cities.data && cities.data.length > 0 || countries.data && countries.data.length > 0)) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Geographic Distribution</h2>
                    `;

                    // Countries Chart (Top 10)
                    if (countries.data && countries.data.length > 0) {
                        reportHtml += `
                            <h3 style="color: #2c3e50; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600;">Sessions by Country (Top 10)</h3>
                            <div id="reportCountriesChart" style="width: 100%; height: 400px; margin-bottom: 3rem; padding-bottom: 2rem; box-sizing: border-box;"></div>
                        `;
                    }

                    // Cities Table
                    if (cities.data && cities.data.length > 0) {
                        reportHtml += `
                            <h3 style="color: #2c3e50; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600;">Top Cities</h3>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 50%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">City</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Percentage</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Sessions</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        cities.data.slice(0, 10).forEach(city => {
                            const cityPct = totalSessions > 0 ? ((parseFloat(city.sessions) / totalSessions) * 100).toFixed(1) : 0;
                            reportHtml += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;"><strong>${city.city || 'N/A'}</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>${cityPct}%</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(city.sessions || 0)}</td>
                                </tr>
                            `;
                        });
                        reportHtml += `
                                </tbody>
                            </table>
                        `;
                    }

                    reportHtml += `
                        </div>
                    `;
                }

                // 6. Device Categories (only if checked)
                if (sections.includes('Tech/Devices') && devices.data && devices.data.length > 0) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Device Categories</h2>
                            <div id="reportDevicesChart" style="width: 100%; height: 400px; margin-bottom: 3rem; padding-bottom: 2rem; box-sizing: border-box;"></div>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 50%;">
                                    <col style="width: 25%;">
                                    <col style="width: 25%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Device Category</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Percentage</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Sessions</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    devices.data.forEach(device => {
                        const devicePct = totalSessions > 0 ? ((parseFloat(device.sessions) / totalSessions) * 100).toFixed(1) : 0;
                        reportHtml += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;"><strong>${device.deviceCategory || 'N/A'}</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;"><strong>${devicePct}%</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(device.sessions || 0)}</td>
                            </tr>
                        `;
                    });
                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 7. Top Events (only if checked)
                if (sections.includes('Events') && events.data && events.data.length > 0) {
                    reportHtml += `
                        <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                            <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Top Events</h2>
                            <div id="reportEventsChart" style="width: 100%; height: 400px; margin-bottom: 3rem; padding-bottom: 2rem; box-sizing: border-box;"></div>
                            <table class="report-table" style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 70%;">
                                    <col style="width: 30%;">
                                </colgroup>
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Event Name</th>
                                        <th style="border: 1px solid #ddd; padding: 0.75rem; text-align: left; font-weight: bold; box-sizing: border-box;">Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    events.data.slice(0, 10).forEach(event => {
                        reportHtml += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box; word-wrap: break-word;"><strong>${event.eventName || 'N/A'}</strong></td>
                                <td style="border: 1px solid #ddd; padding: 0.75rem; box-sizing: border-box;">${formatNumber(event.eventCount || 0)}</td>
                            </tr>
                        `;
                    });
                    reportHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 8. Business Profile (only if checked)
                if (sections.includes('Business Profile')) {
                    // Check if we have insights data
                    const insights = gbpInsights.summary || gbpInsights.data || {};
                    const hasInsights = insights.views && (insights.views.search || insights.views.maps || insights.customerActions?.websiteClicks || insights.customerActions?.directionRequests);

                    if (hasInsights) {
                        reportHtml += `
                            <div style="margin-bottom: 2rem; page-break-inside: avoid; page-break-before: always; width: 100%; box-sizing: border-box; overflow: visible;" class="report-section">
                                <h2 style="color: #2c3e50; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #ff5800;" class="report-section-title">${sectionNum++}. Google Business Profile</h2>
                        `;

                        if (hasInsights) {
                            reportHtml += `
                                <h3 style="color: #2c3e50; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 600;">Performance Insights</h3>
                                <table style="width: 100%; border-collapse: collapse; margin-top: 1rem; border: 1px solid #ddd; box-sizing: border-box; table-layout: fixed; margin-bottom: 2rem;">
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;"><strong>Search Views:</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;">${formatNumber(insights.views.search || 0)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;"><strong>Maps Views:</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;">${formatNumber(insights.views.maps || 0)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;"><strong>Website Clicks:</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;">${formatNumber(insights.customerActions?.websiteClicks || 0)}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;"><strong>Direction Requests:</strong></td>
                                        <td style="padding: 0.75rem; border: 1px solid #ddd; width: 50%; box-sizing: border-box;">${formatNumber(insights.customerActions?.directionRequests || 0)}</td>
                                    </tr>
                                </table>
                            `;
                        }



                        reportHtml += `</div>`;
                    }
                }

                const generatedDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                reportHtml += `
                        <div style="text-align: center; margin-top: 2rem;">
                            <button onclick="window.print()" style="background-color: #7f8c8d; color: white; border: none; padding: 0.75rem 2rem; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 1rem;">
                                üñ®Ô∏è Print
                            </button>
                        </div>
                        
                        <!-- Print footer - will appear on every page -->
                        <div class="print-footer" data-generated-date="${generatedDate}" style="display: none;">
                            <div class="print-footer-content">
                                <span class="print-footer-text">Generated on ${generatedDate}</span>
                                <span class="print-page-number">Page <span class="page-number">1</span> of <span class="total-pages">1</span></span>
                            </div>
                        </div>
                    </div>
                `;

                content.innerHTML = reportHtml;

                // Update page numbers function
                function updatePageNumbers() {
                    const reportContainer = document.getElementById('reportContainer');
                    if (!reportContainer) return;

                    // Calculate approximate total pages based on content height
                    // A4 page height at 96 DPI: ~1123px, minus margins (1cm top + 2.5cm bottom): ~900px usable
                    const pageHeight = 900; // Approximate usable height per page
                    const contentHeight = reportContainer.scrollHeight;
                    const totalPages = Math.max(1, Math.ceil(contentHeight / pageHeight));

                    // Update total pages in all footer instances
                    const totalPagesEls = document.querySelectorAll('.total-pages');
                    totalPagesEls.forEach(el => {
                        el.textContent = totalPages;
                    });

                    // Note: CSS @page margin boxes have limited browser support
                    // The footer will show total pages, and browsers may add their own page numbers
                }

                // Update page numbers after content is loaded and charts are rendered
                setTimeout(updatePageNumbers, 2000);

                // Also update when print dialog opens
                window.addEventListener('beforeprint', function () {
                    updatePageNumbers();
                    // Show footer
                    const footer = document.querySelector('.print-footer');
                    if (footer) {
                        footer.style.display = 'block';
                    }
                });

                window.addEventListener('afterprint', function () {
                    // Hide footer after printing
                    const footer = document.querySelector('.print-footer');
                    if (footer) {
                        footer.style.display = 'none';
                    }
                });

                // Render charts and convert to static images after HTML is inserted
                setTimeout(async () => {
                    // Helper function to convert Plotly chart to image
                    async function convertChartToImage(chartId, chartData, layout, config) {
                        const chartDiv = document.getElementById(chartId);
                        if (!chartDiv) {
                            console.warn(`Chart div not found: ${chartId}`);
                            return null;
                        }

                        try {
                            // Render the chart
                            await Plotly.newPlot(chartId, chartData, layout, config);

                            // Wait a bit for chart to fully render
                            await new Promise(resolve => setTimeout(resolve, 500));

                            // Ensure chart div has valid dimensions
                            if (chartDiv.offsetWidth === 0 || chartDiv.offsetHeight === 0) {
                                console.warn(`Chart ${chartId} has zero dimensions, using defaults`);
                                chartDiv.style.width = chartDiv.style.width || '100%';
                                chartDiv.style.height = chartDiv.style.height || '400px';
                                await new Promise(resolve => setTimeout(resolve, 200));
                            }

                            // Convert to image
                            const imgData = await Plotly.toImage(chartDiv, {
                                format: 'png',
                                width: chartDiv.offsetWidth || 800,
                                height: chartDiv.offsetHeight || 400
                            });

                            // Validate base64 data
                            if (!imgData || typeof imgData !== 'string') {
                                console.error(`Invalid image data for chart ${chartId}:`, typeof imgData);
                                throw new Error('No image data returned from Plotly');
                            }

                            if (!imgData.startsWith('data:image/png;base64,')) {
                                console.error(`Invalid image data format for chart ${chartId}. Expected base64 PNG, got:`, imgData.substring(0, 50));
                                throw new Error('Invalid image data format returned from Plotly');
                            }

                            // Check if base64 data is too short (likely truncated)
                            const base64Part = imgData.split(',')[1];
                            if (!base64Part || base64Part.length < 100) {
                                console.error(`Base64 data appears truncated for chart ${chartId}. Length:`, base64Part?.length || 0);
                                throw new Error('Image data appears to be truncated');
                            }

                            // Create image element and wait for it to load
                            return new Promise((resolve, reject) => {
                                const img = document.createElement('img');
                                img.alt = `Chart: ${chartId}`;
                                img.style.width = '100%';
                                img.style.height = 'auto';
                                img.style.maxWidth = '100%';
                                img.style.marginBottom = '3rem';
                                img.style.paddingBottom = '2rem';
                                img.style.boxSizing = 'border-box';
                                img.style.display = 'block';
                                img.style.objectFit = 'contain';

                                // Wait for image to load before replacing
                                img.onload = () => {
                                    try {
                                        if (!chartDiv.parentNode) {
                                            console.error(`Chart div ${chartId} has no parent node`);
                                            reject(new Error('Chart div has no parent node'));
                                            return;
                                        }
                                        chartDiv.parentNode.replaceChild(img, chartDiv);
                                        console.log(`Successfully converted chart ${chartId} to image`);
                                        resolve(imgData);
                                    } catch (replaceError) {
                                        console.error(`Error replacing chart div for ${chartId}:`, replaceError);
                                        reject(replaceError);
                                    }
                                };

                                // Handle image load errors
                                img.onerror = (error) => {
                                    console.error(`Image failed to load for chart ${chartId}:`, error);
                                    // Keep the chart div as fallback
                                    const errorMsg = document.createElement('div');
                                    errorMsg.style.padding = '1rem';
                                    errorMsg.style.backgroundColor = '#fee';
                                    errorMsg.style.color = '#c00';
                                    errorMsg.style.border = '1px solid #fcc';
                                    errorMsg.textContent = `Chart image failed to load. Chart ID: ${chartId}`;
                                    chartDiv.parentNode.replaceChild(errorMsg, chartDiv);
                                    reject(new Error(`Image load failed for ${chartId}`));
                                };

                                // Set src after attaching event handlers
                                img.src = imgData;

                                // Timeout fallback in case onload never fires
                                setTimeout(() => {
                                    if (img.parentNode === null && chartDiv.parentNode) {
                                        // Image hasn't been inserted yet, try to insert it anyway
                                        try {
                                            chartDiv.parentNode.replaceChild(img, chartDiv);
                                            console.log(`Image inserted via timeout fallback for ${chartId}`);
                                            resolve(imgData);
                                        } catch (err) {
                                            console.warn(`Timeout inserting image for ${chartId}:`, err);
                                            reject(err);
                                        }
                                    } else if (img.parentNode === null) {
                                        console.error(`Cannot insert image for ${chartId}: chart div has no parent`);
                                        reject(new Error('Chart div has no parent node'));
                                    }
                                }, 2000);
                            });
                        } catch (error) {
                            console.error(`Error converting chart ${chartId}:`, error);
                            // Add error message to the chart div
                            const errorMsg = document.createElement('div');
                            errorMsg.style.padding = '1rem';
                            errorMsg.style.backgroundColor = '#fee';
                            errorMsg.style.color = '#c00';
                            errorMsg.style.border = '1px solid #fcc';
                            errorMsg.textContent = `Error generating chart: ${error.message}`;
                            chartDiv.parentNode.replaceChild(errorMsg, chartDiv);
                            return null;
                        }
                    }

                    // Traffic Sources Chart
                    if (sections.includes('Traffic Sources') && sources.data && sources.data.length > 0) {
                        const chartData = sources.data.map(d => ({ name: d.sessionSourceMedium, value: parseInt(d.sessions) }));
                        const sortedData = [...chartData].sort((a, b) => b.value - a.value);
                        const colorPalette = ['#ff5800', '#4a90e2', '#50c878', '#f39c12', '#9b59b6', '#e74c3c', '#1abc9c', '#34495e', '#e67e22', '#16a085'];
                        const colorMap = new Map();
                        sortedData.forEach((item, idx) => {
                            colorMap.set(item.name, colorPalette[idx % colorPalette.length]);
                        });
                        const colors = chartData.map(d => colorMap.get(d.name));
                        await convertChartToImage('reportSourcesChart', [{
                            values: chartData.map(d => d.value),
                            labels: chartData.map(d => d.name),
                            type: 'pie',
                            marker: { colors: colors },
                            textinfo: 'label+percent',
                            textposition: 'outside',
                            domain: { x: [0.1, 0.9], y: [0.1, 0.9] }
                        }], {
                            font: { family: 'Roboto', size: 12 },
                            showlegend: false,
                            margin: { l: 50, r: 50, t: 50, b: 50 },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, displayModeBar: false });
                    }

                    // User Retention Chart
                    if (sections.includes('User Retention') && retention.data && retention.data.length > 0) {
                        const retentionData = retention.data.map(d => ({ name: d.newVsReturning, value: parseInt(d.sessions) }));
                        await convertChartToImage('reportRetentionChart', [{
                            values: retentionData.map(d => d.value),
                            labels: retentionData.map(d => d.name),
                            type: 'pie',
                            marker: { colors: ['#ff5800', '#4a90e2'] },
                            textinfo: 'label+percent',
                            textposition: 'outside',
                            domain: { x: [0.1, 0.9], y: [0.1, 0.9] }
                        }], {
                            font: { family: 'Roboto', size: 12 },
                            showlegend: false,
                            margin: { l: 50, r: 50, t: 50, b: 50 },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, displayModeBar: false });
                    }

                    // Countries Chart (Top 10)
                    if (sections.includes('Geographics') && countries.data && countries.data.length > 0) {
                        const topCountries = countries.data.slice(0, 10);
                        await convertChartToImage('reportCountriesChart', [{
                            x: topCountries.map(c => c.country || 'N/A'),
                            y: topCountries.map(c => parseInt(c.sessions || 0)),
                            type: 'bar',
                            marker: { color: '#ff5800' }
                        }], {
                            font: { family: 'Roboto', size: 12 },
                            title: 'Sessions by Country (Top 10)',
                            xaxis: { title: 'Country', tickangle: -45 },
                            yaxis: { title: 'Sessions' },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, displayModeBar: false });
                    }

                    // Device Categories Chart
                    if (sections.includes('Tech/Devices') && devices.data && devices.data.length > 0) {
                        const deviceData = devices.data.map(d => ({ name: d.deviceCategory, value: parseInt(d.sessions) }));
                        await convertChartToImage('reportDevicesChart', [{
                            values: deviceData.map(d => d.value),
                            labels: deviceData.map(d => d.name),
                            type: 'pie',
                            marker: { colors: ['#ff5800', '#4a90e2', '#50c878', '#f39c12'] },
                            textinfo: 'label+percent',
                            textposition: 'outside'
                        }], {
                            font: { family: 'Roboto', size: 12 },
                            showlegend: true,
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, displayModeBar: false });
                    }

                    // Top Events Chart
                    if (sections.includes('Events') && events.data && events.data.length > 0) {
                        const topEvents = events.data.slice(0, 10);
                        await convertChartToImage('reportEventsChart', [{
                            x: topEvents.map(e => e.eventName),
                            y: topEvents.map(e => parseInt(e.eventCount)),
                            type: 'bar',
                            marker: { color: '#ff5800' }
                        }], {
                            font: { family: 'Roboto', size: 12 },
                            xaxis: { title: 'Event Name', tickangle: -45 },
                            yaxis: { title: 'Event Count' },
                            paper_bgcolor: 'rgba(0,0,0,0)',
                            plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, displayModeBar: false });
                    }
                }, 500);

            } catch (error) {
                content.innerHTML = `<div class="error">Error generating report: ${error.message}</div>`;
            }
        }

        // Generate PDF using html2pdf.js library
        function generatePDF() {
            const button = document.getElementById('pdfButton');
            if (button) {
                button.disabled = true;
                button.textContent = '‚è≥ Generating PDF...';
            }

            // Get the report container (A4 sized)
            const reportContainer = document.getElementById('reportContainer') || document.querySelector('.section[style*="max-width: 794px"]') || document.querySelector('.section[style*="max-width: 900px"]');
            if (!reportContainer) {
                alert('Please generate a report first');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üìÑ Generate PDF Report';
                }
                return;
            }

            // Configure PDF options for A4 paper (210mm x 297mm = 8.27" x 11.69")
            const opt = {
                margin: [0.4, 0.4, 0.4, 0.4], // Smaller margins for more content
                filename: `Tenacious_Stats_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    letterRendering: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 794, // A4 width in pixels at 96 DPI
                    windowHeight: reportContainer.scrollHeight
                },
                jsPDF: {
                    unit: 'mm', // Use millimeters for A4 precision
                    format: 'a4', // 210mm x 297mm
                    orientation: 'portrait',
                    compress: true
                },
                pagebreak: {
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.report-section',
                    after: '.report-section'
                }
            };

            // Generate PDF and open in new tab for review
            html2pdf()
                .set(opt)
                .from(reportContainer)
                .output('blob')
                .then((pdfBlob) => {
                    // Create blob URL
                    const pdfBlobUrl = URL.createObjectURL(pdfBlob);

                    // Open PDF in new tab for review
                    const newWindow = window.open(pdfBlobUrl, '_blank');

                    if (newWindow) {
                        // Clean up blob URL after a delay
                        setTimeout(() => {
                            URL.revokeObjectURL(pdfBlobUrl);
                        }, 1000);
                    } else {
                        // If popup blocked, create download link
                        const link = document.createElement('a');
                        link.href = pdfBlobUrl;
                        link.download = opt.filename;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        setTimeout(() => {
                            URL.revokeObjectURL(pdfBlobUrl);
                        }, 100);
                    }

                    if (button) {
                        button.disabled = false;
                        button.textContent = 'üìÑ Generate PDF Report';
                    }
                })
                .catch((error) => {
                    console.error('PDF generation error:', error);
                    alert('Error generating PDF: ' + error.message);
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'üìÑ Generate PDF Report';
                    }
                });
        }

        // Preview report as image so we can see the output
        async function previewReport() {
            const button = document.getElementById('previewButton');
            if (button) {
                button.disabled = true;
                button.textContent = '‚è≥ Generating preview...';
            }

            // Get the report container (A4 sized)
            const reportContainer = document.getElementById('reportContainer') || document.querySelector('.section[style*="max-width: 794px"]') || document.querySelector('.section[style*="max-width: 900px"]');
            if (!reportContainer) {
                alert('Please generate a report first');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üëÅÔ∏è Preview Report';
                }
                return;
            }

            try {
                // Use html2canvas to create A4-sized image for preview
                const a4Width = 794; // A4 width in pixels at 96 DPI
                const canvas = await html2canvas(reportContainer, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: a4Width,
                    windowWidth: a4Width,
                    windowHeight: reportContainer.scrollHeight
                });

                // Convert canvas to image
                const imgData = canvas.toDataURL('image/png');

                // Open image directly in new tab - simplest approach
                window.open(imgData, '_blank');

                if (button) {
                    button.disabled = false;
                    button.textContent = 'üëÅÔ∏è Preview Report';
                }
            } catch (error) {
                console.error('Preview generation error:', error);
                alert('Error generating preview: ' + error.message);
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üëÅÔ∏è Preview Report';
                }
            }
        }

        // Download report as single high-quality image file
        async function downloadReportImage() {
            const button = document.getElementById('imageButton');
            if (button) {
                button.disabled = true;
                button.textContent = '‚è≥ Generating image...';
            }

            // Get the report container (A4 sized)
            const reportContainer = document.getElementById('reportContainer') || document.querySelector('.section[style*="max-width: 794px"]') || document.querySelector('.section[style*="max-width: 900px"]');
            if (!reportContainer) {
                alert('Please generate a report first');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üíæ Download as Image';
                }
                return;
            }

            try {
                // Use html2canvas to create A4-sized high-quality image
                // A4: 210mm x 297mm = 794px x 1123px at 96 DPI
                // For high quality: scale up but maintain A4 aspect ratio
                const a4Width = 794; // A4 width in pixels at 96 DPI
                const a4Height = 1123; // A4 height in pixels at 96 DPI
                const scale = 3; // High quality scale

                const canvas = await html2canvas(reportContainer, {
                    scale: scale,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    backgroundColor: '#ffffff',
                    width: a4Width,
                    height: Math.max(a4Height, reportContainer.scrollHeight * scale),
                    windowWidth: a4Width,
                    windowHeight: reportContainer.scrollHeight,
                    removeContainer: false
                });

                // Convert canvas to image with maximum quality
                const imgData = canvas.toDataURL('image/png', 1.0);

                // Create download link
                const dateStr = new Date().toISOString().split('T')[0];
                const link = document.createElement('a');
                link.download = `Tenacious_Stats_Report_${dateStr}.png`;
                link.href = imgData;

                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                if (button) {
                    button.disabled = false;
                    button.textContent = 'üíæ Download as Image';
                }
            } catch (error) {
                console.error('Image download error:', error);
                alert('Error generating image: ' + error.message);
                if (button) {
                    button.disabled = false;
                    button.textContent = 'üíæ Download as Image';
                }
            }
        }
    </script>
</body>

</html>